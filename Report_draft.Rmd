---
title: "Warming Model-Species & Soil"
author: "Jinfei Xue, Jianhao Yan, Si Chen"
date: "Oct 27 2018"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

```{r setup, echo = FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1 Introduction

## 1.1 Overview

Global warming has become a significant topic in the ecosystem field. Itâ€™s worthwhile to study in the effects which global warming has brought about. Therefore, a long-term ecosystem warming experiment was established at Harvard Forest (Petersham, MA) in 2002. In this experiment, two 30 x 30 meter plots were established in 2002. One plot is continuously heated to 5 degrees Celsius above ambient temperature, while the other plot is left as a control. A wide variety of ecological response variables have been measured over the course of the experiment. The data were collected from 2002 to 2016 in different time intervals.

In this study, silica (silicon dioxide; SiO2) concentration was measured in the two ecosystem pools. Measurements can be divided into two broad categories including single-time point measurements of silica pools, specifically, green leaves, leaf litter, and soil, and measurement of silica loss from decaying leaves over time, using a litterbag experiment.

Our Client is interested in finding the relationship between temparature and the silica level in different tree species and soil types, and the relationship between temparature and decomposition rate given the factors including tree species, temperature and time.

## 1.2 Outline

There are three seperate datasets corresponding to the three relationship. Therefore, we consider each relationship seperately. For each one, we first conduct exploratory data analysis to explore the relationship among variables in each dataset. Next, we make models to fit each corresponding dataset. Lastly, we interpret our model and discuss conclusions.

# 2 Model1 : Tree Species

## 2.1 Dataset Introduction

The green leaf dataset mainly has variables including Year(the year when sample collected), month(the month when sample collected), species(tree species of leaf, ACRU = Acer rubrum (red maple), QURU = Quercus rubra (red oak)), treatment(experimental treatment: Heated or Control) and X.wt.Bsi(percent biogenic silica in leaves by dry weight (0-100), indicating the silica level)

## 2.2 Exploratory Data Analysis (EDA)

In order to explore the relationship between the silica levels in leaves and some factors, including tree species(ACRU/QURU) and treatments(Heated/Control), and how the silica levels in tree leaves changed as time went by, we first make exploratory data analysis as followings.

```{r, echo = FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(lubridate)
library(car)
library(zoo)
library(stringi)
library(rlang)
```

```{r, echo = FALSE, warning = FALSE}
# green_leaf_bsi dataset
glbsi <- read.csv("green_leaf_bsi.csv")
glbsi_avg <- glbsi %>% 
  group_by(Year, Species, Treatment) %>%
  summarise(avg = mean(X.wt.Bsi))

glbsi_avg_ACRU = glbsi_avg %>% 
  filter(Species == "ACRU")
glbsi_avg_QURU = glbsi_avg %>% 
  filter(Species == "QURU")

glbsi_avg_control = glbsi_avg %>% 
  filter(Treatment == "Control")
glbsi_avg_heated = glbsi_avg %>% 
  filter(Treatment == "Heated")
```


### Figure 1.1 & 1.2: Compare silica levels in leaves under different treatments
```{r, echo = FALSE}
ggplot(data = glbsi_avg_ACRU) +
  aes(x = Year, y = avg, color = Treatment) +
  geom_point(size = 3) + 
  labs(title = "Figure 1.1",
       subtitle = "Silica Level in ACRU Tree Leaves",
       x = "Year",
       y = "Average Silica Level")+
  theme(axis.text.x = element_text(size = 14))+
  theme(axis.text.y = element_text(size = 14))+
  geom_line()
```

```{r, echo = FALSE}
ggplot(data = glbsi_avg_QURU) +
  aes(x = Year, y = avg, color = Treatment) +
  geom_point(size = 3) + 
  labs(title = "Figure 1.2",
       subtitle ="Silica Level in QURU Tree Leaves",
       x = "Year",
       y = "Average Silica Level")+
  theme(axis.text.x = element_text(size = 14))+
  theme(axis.text.y = element_text(size = 14))+
  geom_line()
```

By comparing the two plots above, we can clearly see the silica levels in QURU tree leaves of heated group are higher than that in QURU tree leaves of control group.

### Figure 1.3 & 1.4: Compare Silica levels in different tree species
```{r, echo = FALSE}

ggplot(data = glbsi_avg_control) +
  aes(x = Year, y = avg, color = Species) +
  geom_point(size = 3) + 
  labs(title = "Figure 1.3",
       subtitle ="Silica Level in Control Groups",
       x = "Year",
       y = "Average Silica Level")+
  theme(axis.text.x = element_text(size = 14))+
  theme(axis.text.y = element_text(size = 14))+
  geom_line()
```

```{r, echo = FALSE}
ggplot(data = glbsi_avg_heated) +
  aes(x = Year, y = avg, color = Species) +
  geom_point(size = 3) + 
  labs(title = "Figure 1.4",
       subtitle = "Silica Level in Heated Groups",
       x = "Year",
       y = "Average Silica Level")+
  theme(axis.text.x = element_text(size = 14))+
  theme(axis.text.y = element_text(size = 14))+
  geom_line()
```

By comparing the two plots above, we can clearly see the silica levels in ACRU tree leaves are much higher than that in QURU tree leaves.

# 2.3 Modeling

In the model, X.wt.Bsi is the dependent variable; Species, Treatment, Months and Month are selected as independent variables. Months indicates the number of months from the time when the experiment started to the time when the samples were collected. Month indicates the month when the samples were selected.

In order to make the model fit the data better, we make log transformation for X.wt.Bsi. From the previous EDA, we can find out that the effect of different species on silica level depends on the value of Months. That is to say, the two variables(Species and Months) might interact with each other. Therefore, we add the interaction term for these two variables in the model.

```{r, echo = FALSE}
glbsi <- read.csv("green_leaf_bsi.csv", encoding = "UTF-8")

glbsi$Year <- as.character(glbsi$Year)
glbsi$Month <- as.character(glbsi$Month)
glbsi$Date <- as.yearmon(paste0(glbsi$Year, "-0", glbsi$Month))
glbsi$Months <- time_length(interval(as.yearmon("2002-05"),glbsi$Date), "month")

r_species <- lm(log(X.wt.Bsi) ~ factor(Species) + factor(Treatment) + Months + factor(Month)+factor(Species)*Months, data = glbsi)
```

## 2.4 Discussions

```{r}
summary(r_species)
```

From the regression result, we can see that R-squared is 0.9845(near 1), which means that 98.45% of the variations in dependent variable can be explained by independent variables in the model. 

Besides, p-value of F-statistic is very small, indicating that the linear regression model provides a better fit to the data than a model that contains no independent variables. 

The p-value for each independent variable tests the null hypothesis that the variable has no correlation with the dependent variable. In the regression result, p-values of most of coefficients in the model are smaller than the usual significance level of 0.05, so we should reject the null hypothesis, which means those coefficients are statistically significant and we should not remove them. 

The coefficient of "factor(Species)QURU" is negative, indicating that with the same level of the other variables, the silica level in QURU tree leaves is lower than that in ACRU tree leaves. This result is consistent with the comparison between figure 1.3 and 1.4. The coefficient of "factor(Treatment)Heated" is positive, indicating that with the same level of the other variables, the silica level under heated treatment is lower than that under control treatment. This result is consistent with the comparison between figure 1.1 and 1.2. The coefficient of "Months" is negative, indicating that with the same level of the other variables, the silica level in tree leaves decreased as time went by. This result is also consistent with the overall trends in figures in part 2.2. 

In order to check the fitted model, we make the marginal model plots and residual plots in the appendix, which shows the model fit the data well.

```{r, echo = FALSE}
round(r_species$coefficients,digits = 6)
```

So the linear regression model is:

$log(X.wt.Bsi)=0.179747-1.292069\times QURU+0.067593 \times Heated -0.000713\times Months-0.052270 \times Month_{7}+0.243141 \times Month_{8}+0.001259 \times QURU \times Months$

"QURU" equals to 1 when samples are from QURU tree leaves; "QURU" equals to 0 when samples are from ACRU tree leaves. 

"Heated" equals to 1 when samples are from heated group; "Heated" equals to 0 when samples are from control group. 

If samples are collected in June, then "factor(Month)7" and "factor(Month)8" are both equal to 0; If samples are collected in July, then "factor(Month)7" equal to 1 but "factor(Month)8" equals to 0; If samples are collected in August, then "factor(Month)8" equal to 1 but "factor(Month)7" equals to 0.

"$QURU\times Months$" equals to the value of "Months" when samples are from QURU tree leaves(because "QURU" equals to 1 in this case). However, "$QURU\times Months$" equals to 0 when samples are from ACRU tree leaves(because "QURU" equals to 0 in this case).


------------------------------------------------------------
Model 2 : Soil Layers
-----------------------------------------------------------


# Introduction

The soil dataset mainly includes the following variables:

- Date: The date when sample collected
- Layer: Layer of soil core (organic or mineral)
- Treatment: Experimental treatment (Heated or Control)
- X.wt.Bsi: Percent biogenic silica in leaves by dry weight (0-100), indicating the silica level

# Exploratory Data Analysis (EDA)

In order to explore the relationship between the silica levels in soil and some factors, including the layer of soil core (organic/mineral) and treatments(Heated/Control), and how the silica levels in soil changed as time went by, we first make exploratory data analysis as followings.


```{r, echo = FALSE}
# soil_bsi dataset
soil_bsi <- read.csv("soil_bsi.csv")

soil_avg <- soil_bsi %>% 
  group_by(Date, Layer, Treatment) %>%
  summarise(avg = mean(X.wt.Bsi)) 

soil_avg <- soil_avg[-1,]
soil_avg$Date <- strptime(soil_avg$Date, "%m/%d/%y")
soil_avg$Date <- as.Date(soil_avg$Date)
soil_avg <- arrange(soil_avg,Date)

SM = soil_avg %>% 
  filter(Layer == "Mineral")
SM2 = soil_avg %>% 
  filter(Layer == "Organic")
```

## Compare silica levels under different treatments
```{r, echo = FALSE}
par(mfrow=c(2,1))

ggplot(data = SM) +
  aes(x = Date, y = avg, color = Treatment) +
  geom_point(size = 3) + 
  labs(title = "Figure 2.1",
       subtitle ="Silica Level in Soil Mineral Level",
       x = "Date",
       y = "Average Silica Level")+
  theme(axis.text.x = element_text(size = 14))+
  theme(axis.text.y = element_text(size = 14))+
  geom_line()


ggplot(data = SM2) +
  aes(x = Date, y = avg, color = Treatment) +
  geom_point(size = 3) + 
  labs(title = "Figure 2.2",
       subtitle ="Silica Level in Soil Organic Level",
       x = "Date",
       y = "Average Silica Level")+
  theme(axis.text.x = element_text(size = 14))+
  theme(axis.text.y = element_text(size = 14))+
  geom_line()
```






# 2.3 Modeling


In the model, X.wt.Bsi(Silicalevel) is the dependent variable; Layer, Treatment, deployedtime and season are selected as independent variables. 

"deployedtime" indicates the number of days from the time when the experiment started(2002/05/07) to the time when the samples were collected. "season" indicates the month of the date when the samples were collected.

```{r, echo = FALSE}
soil_bsi <- read.csv("soil_bsi.csv")

soil_bsi$Date<-mdy(soil_bsi$Date)
soil_data<-na.omit(soil_bsi[,c("Date","Layer","Treatment","X.wt.Bsi")])
soil_data<-soil_data
standaeddate<-c(ymd(020507))
soil_data1<-soil_data %>%
  mutate(deployedtime=difftime(Date,standaeddate,units = "days"))
soil_data1$deployedtime<-as.numeric(soil_data1$deployedtime)
colnames(soil_data1)[4]<-"Silicalevel"
soil_data1$Layer<-factor(soil_data1$Layer)
soil_data1$Treatment<-factor(soil_data1$Treatment)
soil_data2<-soil_data1%>%
  mutate(season=month(Date))

soil_model<-lm(Silicalevel~factor(Layer)+factor(Treatment)+deployedtime+factor(season),data = soil_data2)

```
##2.4 Discussion

```{r}
summary(soil_model)
```



From the regression result, we can see that R-squared is 0.162, which means that 16.2% of the variations in dependent variable can be explained by independent variables in the model. 

Besides, p-value of F-statistic is very small, indicating that the linear regression model provides a better fit to the data than a model that contains no independent variables. 

The p-value for each independent variable tests the null hypothesis that the variable has no correlation with the dependent variable. In the regression result, p-values of most of coefficients in the model are smaller than the usual significance level of 0.05, so we should reject the null hypothesis, which means those coefficients are statistically significant and we should not remove them. 

The intercept means that when the mineral layer in May and in controlled group with 0 deployed tike, the silica level is 1.09e. The coefficient of Layer Organic is positive, so it tells us that, with other variables stay the same, the silica level in organic level is higher than mineral level. When we look at the coefficient of treatment, we can know that the the silica level in heated group is higher than controlled group with other variables staying the same. And we can justify our conclusion by figure 2.1&figure 2.2. We can find that the green line(heated) is on the top of red line(controlled). From the model, we can know that the deployed time has negative effects on the silical level with other variables staying the same, which is consistent with the figure 2.1&2.2. What's more, it seems like that silical level in May is higher than the silical level in June with other variables staying the same.

In order to check the fitted model, we make the marginal model plots and residual plots in the appendix, which shows the model fit the data well.



```{r, echo = FALSE}
round(soil_model$coefficients,digits = 6)
```


The regression model is 
$silical level=1.09+0.14 /times Layer+0.1139/times treatment-0.000040/times deployedtime-0.045594/times season$



-----------------------------------------------
Model 3: Silica Level VS Decaying Rate
-----------------------------------------------



# Introduction
This dataset mainly includes these variables
-Species: The species of the leaves that we collected
-Treantment: Heated group and Controlled group
-Time.Deployed: The length of time from the deployed date to collected date
-Mass.Loss: The weight of the leaves caused by decomposition
-X.wt.Bsi: The silica level in leaves


# Exploratory Data Analysis (EDA)

In order to explore the relationship between the silica levels in leaves and decaying rate under different species and treatments, we draw two plots.
```{r, echo = FALSE}
litterbags <- read.csv("litterbags.csv")
datalb <- litterbags[12:162, ]
datalb$Date.Collected <- as.Date(strptime(datalb$Date.Collected, "%m/%d/%y"))
datalb$Date.Deployed <- as.Date(strptime(datalb$Date.Deployed, "%m/%d/%y"))
datalb$Mass.Loss <- as.numeric(datalb$Mass.Loss)
```




```{r, echo = FALSE}
datalb_heated<-datalb%>%
  filter(Treatment=="Warming")%>%
  group_by(Species,Date.Collected)%>%
  summarise(mean=mean(X.wt.Bsi),Mass.Loss=mean(Mass.Loss))
ggplot(data = datalb_heated) +
  aes(x = Date.Collected, y = mean, color = Species) +
  geom_point(size = datalb_heated$Mass.Loss)+
  geom_line() +
  labs(title = "Figure 3.1",
       subtitle = "Heated group vs Decaying Rate",
       caption = "Point size = Decaying Rate",
    y = 'Average silica level') +
  theme_minimal()
```










```{r, echo = FALSE}
datalb_normal<-datalb%>%
  filter(Treatment=="Control")%>%
  group_by(Species,Date.Collected)%>%
  summarise(mean=mean(X.wt.Bsi),Mass.Loss=mean(Mass.Loss))
ggplot(data = datalb_normal) +
  aes(x = Date.Collected, y = mean, color = Species) +
  geom_point(size = datalb_normal$Mass.Loss)+
  geom_line() +
  labs(title = "Figure 3.2",
         subtitle = "Controlled group vs Decaying Rate",
       caption = "Point size = Decaying Rate",
       y = 'Average silica level') +
  theme_minimal()

```




By comparingh these two plots ,we can find that the heated treatment can cause faster decaying rate than the controlled group. What's more, we should notice that the decaying rate increases with the time increases. But we should also notice that it seems like that silica level may not have such a strong relationship with decaying rate. And it is obvious that the silica level in TSCA is the lowest both in heated and controlled group.12


#2.3 Modelling

In this section, our group want to figure out what is the relationship between silica level in leaves and decaying rate. We draw the two plots. And we fit the linear regression model. In this model, we do z-scores to the silica level and log transformation. 
The reponsive variable is silica level, and independent variables are deploy time, mass.loss, tree species and treatment.
```{r, echo = FALSE}

datalb$Time.Deployed<-as.numeric(datalb$Time.Deployed)
datalb1<-datalb%>%
  mutate(stdecaying=scale(Mass.Loss,center = TRUE,scale = TRUE),
         stBsi=scale(X.wt.Bsi,center = TRUE,scale = TRUE))
model_litterbags<-lm(data = datalb1,
                     X.wt.Bsi~factor(Species)+factor(Treatment)+
                       Time.Deployed+Mass.Loss)
summary(model_litterbags)
```

##2.4 Discussion


From the regression result, we can see that R-squared is 0.8228, which means that 82éŠ†?28% of the variations in dependent variable can be explained by independent variables in the model. 

Besides, p-value of F-statistic is very small, indicating that the linear regression model provides a better fit to the data than a model that contains no independent variables. 

The p-value for each independent variable tests the null hypothesis that the variable has no correlation with the dependent variable. In the regression result, p-values of most of coefficients in the model are smaller than the usual significance level of 0.05, so we should reject the null hypothesis, which means those coefficients are statistically significant and we should not remove them. 

The intercept means that, the speciese of ACRU in controlled group that have 0 deployed time and mass loss will have2.2393 silical level. The coefficent of species gives us the information that sillical level differes from species. The BESP has the highest silical level compared with other species with other variables staying the same.And this is consistent with our figure that the line of BESP is on the top of other lines no matter what treatment is. The coefficient of treatment tells us that, with other variables staying the same, the silical level in heated grouop may be lower than controlled group. What's more, the deployed time can have positive effects on the silical level with other variables staying the same which we can find from the EDA that, with time increasing, the silical level tends ti increase. Finally, the Mass.Loss of litter leaves may cause the increase of the silical level in leaves with other variables staying the same. 

In order to check the fitted model, we make the marginal model plots and residual plots in the appendix, which shows the model fit the data well.

```{r, echo = FALSE}
round(model_litterbags$coefficients,digits = 6)
```

The model is 
$silical level= 2.23926+0.2361*BESP-1.57*QURU-2.09*TSCA-0.08*warming+0.00118*Time.Deployed+0.0212*Mass.Lpss$





#                             Appendix

##Model 1
## Marginal Model Plots
```{r, echo = FALSE, warning = FALSE}
marginalModelPlots(r_species)
title(main = "Figure 1.5")
```

Marginal model plots for tree species data shows the dependent variable (log(X.wt.Bsi)) on the vertical axes and the horizontal axes denotes numeric independent values (plotted points) in the fitted linear regression model. Margin model plots provide a graphical representation of model fit by showing the marginal relationships between the dependent variable and independent variables. We fitted a regression function for each of the plots using a lowess smooth function for the data (solid blue line) and for the fitted values (dashed red line). 

From the marginal model plots above, we can see the red dash line for the fitted values almost covers the blue line for data, indicating that the model fit the data well.


## Residual Plots
```{r, echo = FALSE}
rf_species <- fortify(r_species)

# residual plot for species
ggplot(rf_species, aes(x = .fitted, y = .resid, colour = rf_species$`factor(Species)`)) + 
  geom_point()+
  scale_colour_manual(name = "Species", limits = c("ACRU","QURU"), values = c("red", "green2"))+
  stat_smooth(method="loess", col = "black")+geom_hline(yintercept=0, col="black", linetype="dashed")+
  labs(title = "Figure 1.6",
       subtitle = "Residual for Species vs Fitted Plot",
       x = "Fitted values",
       y = "Residuals")+
  theme(axis.text.x = element_text(size = 14))+
  theme(axis.text.y = element_text(size = 14))+
  theme_bw()
```


```{r, echo = FALSE}
# residual plot for treatment
ggplot(rf_species, aes(x = .fitted, y = .resid, colour = rf_species$`factor(Treatment)`))+ 
  geom_point()+
  scale_colour_manual(name = "Treatment", limits = c("Heated","Control"), values = c("red", "green2"))+
  stat_smooth(method="loess", col = "black")+geom_hline(yintercept=0, col="black", linetype="dashed")+
  labs(title = "Figure 1.7",
       subtitle = "Residual for Treatment vs Fitted Plot",
       x = "Fitted values",
       y = "Residuals")+
  theme(axis.text.x = element_text(size = 14))+
  theme(axis.text.y = element_text(size = 14))+
  theme_bw()

```


```{r, echo = FALSE}
       
# residual plot for month
ggplot(rf_species, aes(x = .fitted, y = .resid, colour=rf_species$`factor(Month)`)) + 
  geom_point()+
  scale_colour_manual(name = "Month", limits = c(6, 7, 8), values = c("red", "green2", "blue"))+
  stat_smooth(method="loess", col = "black")+
  geom_hline(yintercept=0, col="black", linetype="dashed")+
  labs(title = "Figure 1.8",
       subtitle = "Residual for Month vs Fitted Plot",
       x = "Fitted values",
       y = "Residuals")+
  theme(axis.text.x = element_text(size = 14))+
  theme(axis.text.y = element_text(size = 14))+
  theme_bw()
```
## summarise

The difference between the observed value of the dependent variable and the fitted value is called the residual. A residual plot is a graph that shows the residuals on the vertical axis and the independent variable on the horizontal axis. One of assumptions for residuals in linear regression model is that the mean of residuals is zero. Therefore, if the points in a residual plot are randomly dispersed around the horizontal line at zero(the dashed black line), the linear regression model is appropriate for the data; otherwise, a non-linear model is more appropriate.

From the residual plots above, we can see that the points are dispersed randomly around the horizontal line at zero. Therefore, we can conclude that the linear model for tree species fits the data well.


##Model 2
Then we look at the residual plot to check the fitted model

## Residual Plots
```{r, echo = FALSE}
plot(soil_model,color=soil_model$Layer,which = 1)
title(main = "Figure 2.3")
```
##summarise

From the residual model, we can find that the dots are evenly distributed around both sides of x=0. And the red line is almost near the x=0 without too many fluctuations. So we can say the model fits well.

##Model 3
## residual plot
```{r, echo = FALSE}
plot(model_litterbags,which = 1)
title(main = "Figure 3.3")
```


## marginal model plots
```{r, echo = FALSE,warning = FALSE}

marginalModelPlots(model_litterbags)

title(main = "Figure 3.4")
```


## summarise
This model can do a great job to describe our data.

Reason 1: The residual plot fits well. The dots evenly distributed, and the red line is almost the same with x=0.

Reason 2: The marginal model plots tell us that the model fits good.